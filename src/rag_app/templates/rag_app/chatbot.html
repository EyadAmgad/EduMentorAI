{% extends "rag_app/layout.html" %}
{% load static %}

{%block body%}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Sidebar for Document Upload -->
        <div class="col-md-3 bg-light border-right p-3">
            <h4 class="mb-3">ðŸ“š Knowledge Base</h4>
            
            <!-- Document Upload Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Upload Documents</h6>
                </div>
                <div class="card-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-group mb-2">
                            <input type="text" id="title" name="title" placeholder="Document title..." required class="form-control form-control-sm">
                        </div>
                        <div class="form-group mb-2">
                            <input type="file" id="file" name="file" accept=".pdf,.txt" required class="form-control form-control-sm">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </form>
                    <div id="upload-status" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Knowledge Base Status -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Status</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Documents:</span>
                        <span class="badge badge-primary" id="doc-count">{{ total_documents }}</span>
                    </div>
                    {% if total_documents == 0 %}
                    <small class="text-muted mt-2 d-block">Upload documents to start chatting!</small>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recently Uploaded Documents -->
            {% if uploaded_docs %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Recent Uploads</h6>
                </div>
                <div class="card-body p-2">
                    {% for doc in uploaded_docs %}
                    <div class="small mb-1 p-1 bg-white rounded border">
                        <i class="fas fa-file-alt text-muted"></i> {{ doc.title|truncatechars:20 }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Chat Interface -->
        <div class="col-md-9 d-flex flex-column">
            <!-- Chat Header -->
            <div class="bg-primary text-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">ðŸ¤– EduMentor AI Chatbot</h4>
                    <button class="btn btn-light btn-sm" onclick="clearChat()">
                        <i class="fas fa-trash"></i> Clear Chat
                    </button>
                </div>
                <small>Ask questions about your uploaded documents</small>
            </div>
            
            <!-- Chat Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3" id="chat-container" style="height: calc(100vh - 200px);">
                <div id="chat-messages">
                    <!-- Welcome Message -->
                    <div class="message bot-message mb-3">
                        <div class="d-flex">
                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                ðŸ¤–
                            </div>
                            <div class="message-content bg-light rounded p-2 flex-grow-1">
                                <strong>EduMentor AI:</strong> Hello! I'm here to help you with questions about your documents. 
                                {% if total_documents == 0 %}
                                Please upload some documents first to get started.
                                {% else %}
                                You have {{ total_documents }} document chunks in your knowledge base. What would you like to know?
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input Area -->
            <div class="border-top p-3">
                <form id="chat-form">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="chat-input" name="query" class="form-control" 
                               placeholder="Type your question here..." 
                               {% if total_documents == 0 %}disabled{% endif %}>
                        <button type="submit" class="btn btn-primary" 
                                {% if total_documents == 0 %}disabled{% endif %}>
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
                <div id="typing-indicator" class="text-muted small mt-1" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> AI is thinking...
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message {
    margin-bottom: 1rem;
}

.user-message .message-content {
    background-color: #007bff !important;
    color: white;
    margin-left: auto;
    max-width: 70%;
}

.bot-message .message-content {
    background-color: #f8f9fa;
    max-width: 70%;
}

.avatar {
    min-width: 35px;
    font-size: 14px;
}

#chat-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.message-content {
    word-wrap: break-word;
    white-space: pre-wrap;
}
</style>

<script>
let chatForm = document.getElementById('chat-form');
let chatInput = document.getElementById('chat-input');
let chatMessages = document.getElementById('chat-messages');
let typingIndicator = document.getElementById('typing-indicator');
let uploadForm = document.getElementById('upload-form');

// Auto-scroll to bottom
function scrollToBottom() {
    let chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Add message to chat
function addMessage(message, isUser = false, isError = false) {
    let messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} mb-3`;
    
    if (isUser) {
        messageDiv.innerHTML = `
            <div class="d-flex justify-content-end">
                <div class="message-content bg-primary text-white rounded p-2 me-2">
                    <strong>You:</strong> ${message}
                </div>
                <div class="avatar bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                    ðŸ‘¤
                </div>
            </div>
        `;
    } else {
        let bgClass = isError ? 'bg-danger text-white' : 'bg-light';
        messageDiv.innerHTML = `
            <div class="d-flex">
                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                    ðŸ¤–
                </div>
                <div class="message-content ${bgClass} rounded p-2 flex-grow-1">
                    <strong>EduMentor AI:</strong> ${message}
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Chat form submission
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    let query = chatInput.value.trim();
    if (!query) return;
    
    // Add user message
    addMessage(query, true);
    
    // Show typing indicator
    typingIndicator.style.display = 'block';
    
    // Disable input while processing
    chatInput.disabled = true;
    
    // Create FormData with the current query value (before clearing input)
    let formData = new FormData();
    formData.append('query', query);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Clear input after creating FormData
    chatInput.value = '';
    
    // Send query to server
    fetch('/query/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        typingIndicator.style.display = 'none';
        chatInput.disabled = false;
        chatInput.focus();
        
        if (data.error) {
            addMessage(data.error, false, true);
        } else {
            addMessage(data.answer);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        typingIndicator.style.display = 'none';
        chatInput.disabled = false;
        chatInput.focus();
        addMessage('Sorry, there was an error processing your request. Please try again.', false, true);
    });
});

// Upload form submission
uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    let formData = new FormData(this);
    let statusDiv = document.getElementById('upload-status');
    
    statusDiv.innerHTML = '<small class="text-info"><i class="fas fa-spinner fa-spin"></i> Uploading...</small>';
    
    fetch('/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            statusDiv.innerHTML = `<small class="text-danger">${data.error}</small>`;
        } else {
            statusDiv.innerHTML = `<small class="text-success"><i class="fas fa-check"></i> Uploaded successfully!</small>`;
            
            // Update document count
            document.getElementById('doc-count').textContent = data.total_documents_in_knowledge_base;
            
            // Enable chat if it was disabled
            chatInput.disabled = false;
            chatForm.querySelector('button').disabled = false;
            
            // Add system message about new document
            addMessage(`Document "${data.filename}" has been added to the knowledge base. You can now ask questions about it!`);
            
            // Reset form
            uploadForm.reset();
            
            // Clear status after 3 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }
    })
    .catch(error => {
        statusDiv.innerHTML = '<small class="text-danger">Upload failed. Please try again.</small>';
    });
});

// Clear chat function
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        chatMessages.innerHTML = `
            <div class="message bot-message mb-3">
                <div class="d-flex">
                    <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                        ðŸ¤–
                    </div>
                    <div class="message-content bg-light rounded p-2 flex-grow-1">
                        <strong>EduMentor AI:</strong> Chat cleared! How can I help you today?
                    </div>
                </div>
            </div>
        `;
    }
}

// Focus on chat input when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!chatInput.disabled) {
        chatInput.focus();
    }
});
</script>
{%endblock%}
